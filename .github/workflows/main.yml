name: React Native CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment for build'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  build-android:
    name: Android CI/CD
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        uses: bahmutov/npm-install@v1

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup .env file
        run: |
          echo "Selected environment: $ENVIRONMENT"

          if [ "$ENVIRONMENT" = "production" ]; then
            echo "${{ secrets.ENV_PROD_BASE64 }}" | base64 -d > .env
            echo ".env file configured for production."
          elif [ "$ENVIRONMENT" = "staging" ]; then
            echo "${{ secrets.ENV_STAGING_BASE64 }}" | base64 -d > .env
            echo ".env file configured for staging."
          else
            echo "${{ secrets.ENV_DEV_BASE64 }}" | base64 -d > .env
            echo ".env file configured for development."
          fi
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}

      - name: ðŸ” Setup and verify .env file
        run: |
          echo "ðŸ”§ Selected environment: $ENVIRONMENT"

          case "$ENVIRONMENT" in
            production)
              echo "${{ secrets.ENV_PROD_BASE64 }}" | base64 -d > .env
              echo "âœ… .env file configured for production."
              ;;
            staging)
              echo "${{ secrets.ENV_STAGING_BASE64 }}" | base64 -d > .env
              echo "âœ… .env file configured for staging."
              ;;
            *)
              echo "${{ secrets.ENV_DEV_BASE64 }}" | base64 -d > .env
              echo "âœ… .env file configured for development."
              ;;
          esac

          echo "ðŸ” Displaying safe .env variables:"
          # Only print non-sensitive values here
          grep -E '^(ENV|BASE_URL)=' .env || echo "No public .env variables found."
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}

      # ðŸ” Add debug.keystore
      - name: Setup Debug Keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > android/app/debug.keystore

      # ðŸ” Add release.keystore & gradle properties
      - name: Setup Release Keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
          echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> android/gradle.properties
          echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}" >> android/gradle.properties
          echo "RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}" >> android/gradle.properties

      # ðŸ” Setup Release Keystore and Gradle Properties
      - name: Setup Release Keystore
        run: |
          mkdir -p android/app
          echo "ðŸ“¦ Creating release.keystore..."
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore

          if [ -f android/app/release.keystore ]; then
            echo "âœ… release.keystore created successfully."
            echo "ðŸ“ Location: android/app/release.keystore"
            echo "ðŸ“ Size: $(du -h android/app/release.keystore | cut -f1)"
          else
            echo "âŒ Failed to create release.keystore!"
          fi

          echo "ðŸ“ Writing gradle.properties values..."
          echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> android/gradle.properties
          echo "RELEASE_KEY_PASSWORD=********"  # Masked
          echo "RELEASE_STORE_PASSWORD=********"  # Masked
          echo "âœ… gradle.properties configured."

      - name: Build Debug APK
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease

      # - name: Install Firebase CLI
      #   run: npm install -g firebase-tools

      # - name: Upload Debug APK to Firebase (Debug Testers)
      #   run: |
      #     firebase appdistribution:distribute android/app/build/outputs/apk/debug/app-debug.apk \
      #       --app 1:167074286498:android:34b05a46f0dbbfe41700fb \
      #       --token ${{ secrets.FIREBASE_TOKEN }} \
      #       --groups debug-testers \
      #       --release-notes "Debug build from GitHub Actions for ${{ github.event.inputs.environment }}"

      # - name: Upload Release APK to Firebase (Release Testers)
      #   run: |
      #     firebase appdistribution:distribute android/app/build/outputs/apk/release/app-release.apk \
      #       --app 1:167074286498:android:34b05a46f0dbbfe41700fb \
      #       --token ${{ secrets.FIREBASE_TOKEN }} \
      #       --groups release-testers \
      #       --release-notes "Release build from GitHub Actions for ${{ github.event.inputs.environment }}"

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: |
            android/app/build/outputs/apk/debug/app-debug.apk
            android/app/build/outputs/apk/release/app-release.apk
